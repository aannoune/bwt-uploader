<script src="../pdfjs-dist/build/pdf.min.js"></script>
<script>
    var resizer = (function() {
        var applyScale, scaleDown, stepDown, stepScale, scaleData;
        var preview, ctx;
        var scaledData;
        stepScale = 0.9;
        scaleDown = function(image, targetScale) {
            var currentScale = 1;
            while (currentScale * stepScale > targetScale) {
                currentScale *= stepScale;
                image = stepDown(image);
            }
            return {
                image: image,
                remainingScale: targetScale / currentScale
            };
        };
        stepDown = function(image) {
            var temp;
            temp = {};
            temp.canvas = document.createElement('canvas');
            temp.ctx = temp.canvas.getContext('2d');
            temp.canvas.width = image.width * stepScale + 1;
            temp.canvas.height = image.height * stepScale + 1;
            temp.ctx.scale(stepScale, stepScale);
            temp.ctx.drawImage(image, 0, 0);
            return temp.canvas;
        };
        applyScale = function(img, canvas, height) {
            var canvas = document.createElement('canvas');
            canvas.setAttribute('height', height);
            canvas.setAttribute('width', (height / img.height) * img.width);
            scale = (height / img.height).toFixed(2);
            var ctx = canvas.getContext('2d');
            scaledData = scaleDown(img, scale);
            ctx.scale(scaledData.remainingScale, scaledData.remainingScale);
            ctx.drawImage(scaledData.image, 2, 2);
            return canvas.toDataURL();
        };
        return {
            scaleImage: applyScale
        }
    })();

    BwtUploadBehavior = {
        properties: {
            error: {
                type: Object,
                value: {
                    val: false,
                    msg: ''
                },
                notify: true,
                reflectToAttribute: true
            },

            file: {
                type: Object,
                value: {},
                notify: true
            },
            /**
             * The type of placeholder, accepts either one of two arguments; square or circle
             **/
            theme: {
                type: String,
                value: 'circle',
                notify: true
            },

            image: {
                type: String,
                value: '',
                notify: true
            },
            /**
             * location of the placeholder image
             **/
            placeholder: {
                type: String,
                value: '/images/placeholder.png',
                notify: true
            },
            /**
             * value to be databinded, this will give the value of the output url
             **/
            value: {
                type: String,
                value: ''
            }

        },
        _hasWrongMimeType: function(file, acceptedFileTypes) {
            acceptedFileTypes = acceptedFileTypes.split(',');
            if (acceptedFileTypes.indexOf(file.type) == -1)
                this.error = {
                    msg: 'Invalid file type, please upload an accepted file type',
                    val: true
                };
        },
        _validateFile: function(files) {
            if (files.length > 1) {
                this.error = {
                    msg: 'You can only upload one file at a time',
                    val: true
                };
            }
            this._hasWrongMimeType(files[0], this.acceptedFileTypes);
            this._hasExceededMaximumFileSize(files[0]);
        },
        _hasExceededMaximumFileSize: function(file) {
            if ( file.size > (this.maxFileSize*1024) )
                this.error = {
                    msg: 'The uploaded file exceeds ' + this.maxFileSize + ' KB',
                    val: true
                };
        },
        _uploadFile: function(files) {
            this._validateFile(files);
            if (this.error.val) return;

            this.set('file', files[0]);
            this.file.progress = 10;
            this.file.error = false;
            this.file.complete = false;
            this._startPreviewAndAjax(this.file);
        },
        _startPreviewAndAjax: function(file) {
            if (file.type === 'application/pdf') {
                this._getDocumentPreview(file);
                this._uploadDocument() ;
            } else {
                this.$.preview._createImagePreview(file)
                    .then(function(img) {
                        return this._createImageFile(img);
                    }.bind(this))
                    .then(function(image) {
                        var newImage = image.src;
                        if (this.resize && image.height > this.height) {
                            newImage = resizer.scaleImage(image, this.height);
                            // checking if file size of new image is bigger than the original
                            newImage = (newImage.length > img.length) ? image.src : newImage;
                        }
                        this._uploadImage(newImage);
                    }.bind(this));
            }
        },
        _getDocumentPreview: function(file) {
            PDFJS.workerSrc = '/bower_components/pdfjs-dist/build/pdf.worker.js';
            this._createArrayBufferFie(file)
                .then(function (buffer) {
                  PDFJS.getDocument(buffer).then(function(pdf) {
                      pdf.getPage(1).then(function(page) {

                          var scale = 1.5;
                          var viewport = page.getViewport(scale);
                          var canvas = document.createElement('canvas');
                          var context = canvas.getContext('2d');
                          canvas.height = viewport.height;
                          canvas.width = viewport.width;

                          var task = page.render({
                              canvasContext: context,
                              viewport: viewport
                          });

                          task.promise.then(function() {
                              this.image = canvas.toDataURL('image/jpeg');
                              console.log(this.image);
                          }.bind(this));
                      }.bind(this))
                  }.bind(this));
                }.bind(this));
        },
        _createImageFile: function(image) {
            var img = new Image();
            img.src = image;
            return new Promise(function(resolve, reject) {
                img.onload = resolve(img);
            });
        },
        _createArrayBufferFie: function(file) {
          var  fileReader = new FileReader();
          return new Promise(function (resolve,reject) {
            fileReader.onload = function(ev) {
                resolve(fileReader.result);
            }
            fileReader.readAsArrayBuffer(file);
          });
        },
        _uploadImage: function(image) {
          // increase this.file prgoress
          // set body
          // file , extra data
          // { file: , extradata }
          // handle the response of this
          // error as well the success
            var ajax = this.$.ajaxElement;
            ajax.body=this.body;
            ajax.body.file = image;
            console.log( ajax.body );
            this.$.ajaxElement.generateRequest();
        },
      
    };
</script>
