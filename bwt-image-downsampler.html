<<dom-module id="bwt-image-downsampler">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

  </template>
  <script>
    var resizer = (function() {
      var applyScale, scaleDown, stepDown, stepScale, scaleData;
      var preview,ctx;
      var scaledData;
      stepScale = 0.9;
      scaleDown = function(image, targetScale) {
          var currentScale = 1;
          while (currentScale * stepScale > targetScale) {
              currentScale *= stepScale;
              image = stepDown(image);
          }
          return {
              image: image,
              remainingScale: targetScale / currentScale
          };
      };
      stepDown = function(image) {
          var temp;
          temp = {};
          temp.canvas = document.createElement('canvas');
          temp.ctx = temp.canvas.getContext('2d');
          temp.canvas.width = image.width * stepScale + 1;
          temp.canvas.height = image.height * stepScale + 1;
          temp.ctx.scale(stepScale, stepScale);
          temp.ctx.drawImage(image, 0, 0);
          return temp.canvas;
      };
      applyScale = function(img,canvas) {
        var scale;
        if(img.width > img.height) {
          canvas.width = 800; // final image proportions
          canvas.height = (800/img.width)*img.height;
          scale = (800/img.width).toFixed(2);
        }else {
          canvas.height = 800; // final image proportions
          canvas.width = (800/img.height)*img.width;
          scale = (800/img.height).toFixed(2);
        }
        var ctx = canvas.getContext('2d');
        scaledData = scaleDown(img, scale);
        ctx.scale(scaledData.remainingScale, scaledData.remainingScale);
        ctx.drawImage(scaledData.image, 2, 2);
        return canvas.toDataURL();
      };
      return {
          scaleImage: applyScale
      }
    })();

    Polymer({
      is: 'bwt-image-downsampler'
    });
  </script>
</dom-module>
